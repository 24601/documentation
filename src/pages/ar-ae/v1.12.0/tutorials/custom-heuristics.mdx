عنوان: "التحليل الشخصي"
metaTitle: "التحليل الشخصي"
metaDescription: "كيفية تمديد خدمة التحليل الشخصي بالخوارزمية الخاصة بك"

نحن نستخدم المصطلح التحليل الشخصي للخوارزميات البسيطة والمحمية المستخدمة للكشف عن المشاكل مثل معالج المعالجات العالية أو النقرات الغير مرغوب فيها. هنا سنستخدم مثال واحد لفهم كيفية عمل التحليل الشخصي وكيفية إنشاء الكاشف الخاص بك ورؤية نتائجه في DevTools.

## قوالب

يوجد قالب للتحليل الشخصي في المسار `openreplay/backend/pkg/handlers/custom`.


```tsx
package custom

import . "openreplay/backend/pkg/messages"

type CustomHandler struct {
	lastTimestamp uint64
}

func (h *CustomHandler) Handle(message Message, messageID uint64, timestamp uint64) Message {
	h.lastTimestamp = timestamp
	return nil
}

func (h *CustomHandler) Build() Message {
	return nil
}
```


عندما يتم إنشاء طريقة التحليل الشخصي، يمكن إضافتها عن طريق تعديل الملف `main.go` في المسار `openreplay/backend/cmd/heuristics` عن طريق استيراد الوحدة المخصصة وإضافة الوظيفة المخصصة إلى معالج الرسائل.

```tsx
package main

import (
        "log"
        "openreplay/backend/internal/config/heuristics"
        "openreplay/backend/pkg/handlers"
        web2 "openreplay/backend/pkg/handlers/web"
        "openreplay/backend/pkg/intervals"
        logger "openreplay/backend/pkg/log"
        "openreplay/backend/pkg/messages"
        "openreplay/backend/pkg/queue"
        "openreplay/backend/pkg/queue/types"
        "openreplay/backend/pkg/sessions"
        "os"
        "os/signal"
        "syscall"
        "time"
        // Import custom modules here
)

func main() {
        log.SetFlags(log.LstdFlags | log.LUTC | log.Llongfile)

        // Load service configuration
        cfg := heuristics.New()

        // HandlersFabric returns the list of message handlers we want to be applied to each incoming message.
        handlersFabric := func() []handlers.MessageProcessor {
                return []handlers.MessageProcessor{
                        // web handlers
                        &web2.ClickRageDetector{},
                        &web2.CpuIssueDetector{},
                        &web2.DeadClickDetector{},
                        &web2.MemoryIssueDetector{},
                        &web2.NetworkIssueDetector{},
                        &web2.PerformanceAggregator{},
                        // Add custom handlers here
                }
        }
        ...
}
```


## مثال عاجل للعودة

لهذا المثال، سنقوم بإنشاء التحليل الشخصي العاجل للعودة، والذي سيرسل إشارة كلما عادنا إلى نفس الرابط خلال أقل من خمس ثوانٍ. الطريقة المنفذة للكشف عن هذا الحدث ستستفيد من أحداث `SetPageLocation` و `MouseClick`. كلما كان هناك نقرة للفأرة، نحدث تاريخ الحالي وإذا تم تلقي رسالة `SetPageEvent` خلال خمس ثوانٍ تشير إلى صفحة الويب الحالية، ثم نعيد حدث QuickReturn.

للبدء، دعنا ننشئ الملف `quickreturn.go` في المسار `openreplay/backend/pkg/handlers/custom` ويحتوي على الكود الظاهر أدناه


```go
package custom
import (
    "log"
    "encoding/json"
    . "openreplay/backend/pkg/messages"
)
type QuickReturnDetector struct {
    timestamp   uint64
    currentPage string
    lastPage    string
}

type CustomPayload struct {
        Timestamp   uint64 `json:"timestamp"`
        CurrentPage string `json:"current_page"`
}

// If received SetPageLocation on same 
func (h *QuickReturnDetector) HandleSetPageLocation(msg *SetPageLocation, messageID uint64, timestamp uint64) Message {
    if (h.timestamp + 5000 >= msg.NavigationStart && h.lastPage == msg.URL) {
        h.timestamp = msg.NavigationStart
        return h.Build()
    }
    h.lastPage = h.currentPage
    h.currentPage = msg.URL
    h.timestamp = msg.NavigationStart
    return nil
}
// detect when a button is clicked (selector must have string 'button' in it)
func (h *QuickReturnDetector) HandleMouseClick(msg *MouseClick, messageID uint64, timestamp uint64) {
    h.timestamp = timestamp
}
func (h *QuickReturnDetector) Handle(message Message, messageID uint64, timestamp uint64) Message {
    switch msg := message.(type) {
    case *SetPageLocation:
        if msg.NavigationStart != 0 {
            return h.HandleSetPageLocation(msg, messageID, timestamp)
        }
    case *MouseClick:
        h.HandleMouseClick(msg, messageID, timestamp)
    }
    return nil
}
func (h *QuickReturnDetector) Build() Message {
    payload := &CustomPayload{
        CurrentPage: h.currentPage,
        Timestamp: h.timestamp,
    }
    payloadData, err := json.Marshal(payload)
    if err != nil {
            log.Println("JSON encoding error", err)
            return nil
    }
    payloadString := string(payloadData)
    event := &CustomEvent {
        MessageID: 122,
        Timestamp: h.timestamp,
        Name:      "quickreturn",
        Payload:   payloadString,
    }
    return event
}
```


الآن تم إنشاء التحليل الشخصي، فقط يحتاج إلى تمكينه. لذلك، يجب إضافة التحليل الشخصي إلى الملف `main.go` في المسار `openreplay/backend/cmd/heuristics` كما يلي:


```tsx
package main

import (
        "log"
        "openreplay/backend/internal/config/heuristics"
        "openreplay/backend/pkg/handlers"
        web2 "openreplay/backend/pkg/handlers/web"
        "openreplay/backend/pkg/intervals"
        logger "openreplay/backend/pkg/log"
        "openreplay/backend/pkg/messages"
        "openreplay/backend/pkg/queue"
        "openreplay/backend/pkg/queue/types"
        "openreplay/backend/pkg/sessions"
        "os"
        "os/signal"
        "syscall"
        "time"
        // Add custom module
        custom "openreplay/backend/pkg/custom"
)

func main() {
        log.SetFlags(log.LstdFlags | log.LUTC | log.Llongfile)

        // Load service configuration
        cfg := heuristics.New()

        // HandlersFabric returns the list of message handlers we want to be applied to each incoming message.
        handlersFabric := func() []handlers.MessageProcessor {
                return []handlers.MessageProcessor{
                        // web handlers
                        &web2.ClickRageDetector{},
                        &web2.CpuIssueDetector{},
                        &web2.DeadClickDetector{},
                        &web2.MemoryIssueDetector{},
                        &web2.NetworkIssueDetector{},

                        // The new handler
                        &custom.QuickReturnDetector{},
                }
        }
        ...
}
```

