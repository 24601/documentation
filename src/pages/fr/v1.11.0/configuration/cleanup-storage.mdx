---
titre: "Nettoyage du stockage"
metaTitle: "Nettoyage du stockage"
metaDescription: "Supprimez en vrac les enregistrements de la base de données et nettoyez votre stockage."
---
import Aside from '~/components/Aside.astro'

Chaque enregistrement existe sous la forme d'un fichier et d'une entrée dans la base de données. OpenReplay déverse ce qui est nécessaire pour rejouer une session (mutations DOM, coordonnées de la souris, journaux de la console, activité réseau et bien plus encore) dans un seul fichier. Ces fichiers sont par défaut stockés sur votre instance, ils constituent donc la majeure partie de son stockage. Les métadonnées de la session seront stockées dans la base de données PostgreSQL à jamais, mais après 180 jours, le fichier contenant l'enregistrement sera expiré/supprimé via une politique de cycle de vie minio.

Il existe 2 façons de nettoyer le stockage dans votre instance OpenReplay : automatisé (CLI) et manuel.

## Nettoyage des données (CLI)

Ce processus est entièrement automatisé via notre CLI. Exécutez simplement la commande ci-dessous pour nettoyer votre stockage en supprimant des données à la fois de Postgres (où sont stockés les événements) et de minio (où sont enregistrés les enregistrements) :


```bash
# To clean data older than 14 days
openreplay --cleanup 14
```


## Nettoyage des données (manuel)

Les données peuvent être supprimées à la fois de la base de données (où sont stockés les événements) et de minio (où sont enregistrés les enregistrements).

### Nettoyage des enregistrements

Si vous avez besoin de libérer de l'espace, connectez-vous à votre instance OpenReplay et suivez les étapes ci-dessous :

1. Exécutez `k9s -n db`
2. Utilisez les touches fléchées du clavier pour naviguer dans la liste et accéder au conteneur `minio-*`
3. Appuyez sur `s` pour avoir un accès shell au conteneur Minio (stockage d'objets)
4. Exécutez `mc alias set minio http://localhost:9000 $MINIO_ACCESS_KEY $MINIO_SECRET_KEY`
5. Exécutez `mc rm --recursive --dangerous --force --older-than 7d minio/mobs` (c'est-à-dire supprimer les fichiers qui sont plus vieux que 7 jours)
6. Utilisez `exit` pour quitter le conteneur Minio
7. Exécutez `:quit` pour quitter la CLI Kubernetes

#### Modifier la politique de cycle de vie par défaut

Si vous utilisez minio (installation vanilla), vous pouvez modifier la politique de cycle de vie par défaut de cette façon :

1. Exécutez `k9s -n db`
2. Utilisez les touches fléchées du clavier pour naviguer dans la liste et accéder au conteneur `minio-*`
3. Appuyez sur `s` pour avoir un accès shell au conteneur Minio (stockage d'objets)
4. Exécutez `export MINIO_ACCESS_KEY=<secretKey from /var/lib/openreplay/vars.yaml>`
5. Exécutez `export MINIO_SECRET_KEY=<secretKey from /var/lib/opereplay/vars.yaml>`
6. Exécutez `mc alias set minio http://localhost:9000 $MINIO_ACCESS_KEY $MINIO_SECRET_KEY`
7. Pour nettoyer automatiquement les enregistrements 14 jours après la création


```bash
export EXPIRATION_DAYS=14
cat <<EOF > /tmp/lifecycle.json
{
    "Rules": [
        {
            "Expiration": {
                "Days": $EXPIRATION_DAYS
            },
            "ID": "${bucket}",
            "Status": "Enabled"
        }
    ]
}
EOF
mc ilm import minio/mobs < /tmp/lifecycle.json
```


8. Utilisez `exit` pour quitter le conteneur Minio
9. Exécutez `:quit` pour quitter la CLI Kubernetes

### Nettoyage de la base de données (PostgeSQL)

Selon votre utilisation, les données peuvent être supprimées de différentes tables et de différentes manières.

#### Se connecter à PostgreSQL

Connectez-vous à votre instance OpenReplay, puis :

1. Exécutez `k9s -n db`
2. Utilisez les touches fléchées du clavier pour naviguer dans la liste et accéder au conteneur `postgresql-*`
3. Appuyez sur `s` pour avoir un accès shell au conteneur Postgres
4. Exécutez `PGPASSWORD=MY_PG_PASSWORD psql -U postgres` (remplacez `MY_PG_PASSWORD` par la valeur de la variable `postgresqlPassword` du fichier `/var/lib/openreplay/vars.yaml`)
5. Exécutez votre requête de suppression (ou toute autre requête)
6. Tapez `exit` pour quitter le client postgresql
7. Utilisez `exit` pour quitter le conteneur Postgres
8. Exécutez `:quit` pour quitter la CLI Kubernetes

#### Vérifier la taille des tables

Pour vérifier la taille des tables, vous pouvez exécuter la requête suivante :


```sql
SELECT nspname AS "name_space",
       relname AS "relation",
       pg_size_pretty(
               pg_total_relation_size(C.oid)
           )   AS "total_size"
FROM pg_class C
         LEFT JOIN pg_namespace N ON (N.oid = C.relnamespace)
WHERE nspname NOT IN ('pg_catalog','information_schema')
  AND C.relkind <> 'i'
  AND nspname !~ '^pg_toast'
ORDER BY pg_total_relation_size(C.oid) DESC
LIMIT 20;
```


#### Supprimer des événements spécifiques

Nous avons remarqué que la plupart des utilisateurs d'OpenReplay, après avoir vérifié les résultats de la section précédente, ont décidé de supprimer des événements spécifiques plutôt que de nettoyer les sessions (en particulier `events.resources` et `events_common.requests`).

Pour supprimer toutes les données d'événement, vous pouvez exécuter l'une des requêtes suivantes, mais gardez à l'esprit que cela affectera les valeurs des cartes, les cartes de clics, la liste des événements et d'autres fonctionnalités.

<Aside type="caution">
	Ceci est fait à vos risques et périls, alors soyez extrêmement prudent lors de l'exécution de telles actions dans la base de données car elles sont irréversibles et peuvent affecter plusieurs fonctionnalités d'OpenReplay.
</Aside>


```sql
--- To delete all data related to a specific event

-- The next 2 tables are usually the biggest ones, and they affect some cards only
TRUNCATE TABLE events.resources;
TRUNCATE TABLE events_common.requests;

-- The next table will affect click-maps and events list of session's replay
TRUNCATE TABLE events.clicks;
TRUNCATE TABLE events.errors;
TRUNCATE TABLE events.graphql;
TRUNCATE TABLE events.inputs;
TRUNCATE TABLE events.pages;
TRUNCATE TABLE events.performance;
TRUNCATE TABLE events.state_actions;
TRUNCATE TABLE events_common.customs;
TRUNCATE TABLE events_common.issues;
```


#### Supprimer des sessions spécifiques par temps

Si vous souhaitez nettoyer toutes les sessions, passez à [la prochaine partie](#delete-all-sessions) car c'est plus rapide et libère immédiatement l'espace de stockage.

Utilisez la requête SQL ci-dessous si vous souhaitez nettoyer les données de votre base de données (PostgreSQL). Remplacez `2021-01-01` par la date à partir de laquelle conserver les enregistrements. C'est une suppression en cascade, de sorte que tous les enregistrements ainsi que leurs événements correspondants seront supprimés de la base de données.

<Aside type="caution">
	Ceci est fait à vos risques et périls, alors soyez extrêmement
```sql
--- Cascade delete all sessions and their related events captured before Jan 1st, 2021
DELETE FROM public.sessions WHERE start_ts < extract(epoch from '2021-01-01'::date) * 1000;
```
